# LiveMediaServer Development Mode Configuration
# ä¸“é—¨ç”¨äºæœ¬åœ°å¼€å‘çš„Docker Composeé…ç½®
# ä½¿ç”¨å·æŒ‚è½½å®ç°å¿«é€Ÿä»£ç è¿­ä»£ï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒ

version: '3.8'

services:
  rtmp-server:
    # ä½¿ç”¨åŒ…å«JDKçš„åŸºç¡€é•œåƒï¼Œæ— éœ€æ„å»º
    image: openjdk:17-slim
    container_name: livemediaserver_rtmp-server_dev
    
    # å°†æœ¬åœ°æºç ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…
    volumes:
      - ./rtmp-server:/app
      - ./rtmp-server/bin:/app/bin  # ç¼–è¯‘è¾“å‡ºç›®å½•
    
    working_dir: /app
    
    # å¼€å‘æ¨¡å¼å¯åŠ¨å‘½ä»¤ï¼šç¼–è¯‘å¹¶è¿è¡Œ
    command: >
      sh -c "
        echo 'ğŸ”§ RTMP Server Development Mode' &&
        echo 'ğŸ“ Creating bin directory...' &&
        mkdir -p bin &&
        echo 'ğŸ”¨ Compiling Java sources...' &&
        javac -encoding UTF-8 -d bin src/com/example/rtmpserver/*.java &&
        echo 'âœ… RTMP Server compiled successfully!' &&
        echo 'ğŸš€ Starting RTMP Server...' &&
        java -cp bin com.example.rtmpserver.Server
      "
    
    ports:
      - "1935:1935"
    
    networks:
      - live-media-net
    
    # ç¯å¢ƒå˜é‡
    environment:
      - WEB_API_URL=http://web-api-server:8080
    
    # å¥åº·æ£€æŸ¥ - æ£€æŸ¥Javaè¿›ç¨‹æ˜¯å¦å­˜åœ¨
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  web-api-server:
    # ä½¿ç”¨åŒ…å«Mavenå’ŒJDKçš„åŸºç¡€é•œåƒ
    image: maven:3.8-openjdk-17
    container_name: livemediaserver_web-api-server_dev

    # å·æŒ‚è½½ï¼šæºç  + Mavenç¼“å­˜
    volumes:
      - ./web-api-server:/app
      - ~/.m2:/root/.m2  # Mavenä¾èµ–ç¼“å­˜æŒä¹…åŒ–
      - ./web-api-server/logs:/app/logs  # æ—¥å¿—ç›®å½•
      - hls-storage:/app/hls  # HLSæ–‡ä»¶å…±äº«å­˜å‚¨

    working_dir: /app

    # ä½¿ç”¨Spring Boot Mavenæ’ä»¶å¯åŠ¨ï¼Œæ”¯æŒçƒ­é‡è½½
    command: >
      sh -c "
        echo 'ğŸ”§ Web API Server Development Mode' &&
        echo 'ğŸ“¦ Checking dependencies...' &&
        mvn dependency:resolve &&
        echo 'âœ… Dependencies resolved!' &&
        echo 'ğŸš€ Starting Spring Boot with DevTools...' &&
        mvn spring-boot:run -Dspring-boot.run.jvmArguments='-Xmx1g -Xms512m' -X
      "

    ports:
      - "8080:8080"
      - "35729:35729"  # LiveReloadç«¯å£

    networks:
      - live-media-net

    # ç¯å¢ƒå˜é‡
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_DEVTOOLS_LIVERELOAD_ENABLED=true
      - JAVA_OPTS=-Xmx1g -Xms512m -XX:+UseG1GC
      - TRANSCODER_SERVICE_URL=http://transcoder-service:8081

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  transcoder-service:
    # ä½¿ç”¨åŒ…å«FFmpegçš„Javaé•œåƒ
    image: openjdk:17-slim
    container_name: livemediaserver_transcoder-service_dev

    # å·æŒ‚è½½ï¼šæºç  + HLSè¾“å‡º
    volumes:
      - ./transcoder-service:/app
      - hls-storage:/app/hls  # HLSæ–‡ä»¶å…±äº«å­˜å‚¨

    working_dir: /app

    # å¼€å‘æ¨¡å¼å¯åŠ¨å‘½ä»¤
    command: >
      sh -c "
        echo 'ğŸ”§ Transcoder Service Development Mode' &&
        echo 'ğŸ“¦ Installing FFmpeg...' &&
        apt-get update && apt-get install -y ffmpeg curl &&
        echo 'ğŸ”¨ Compiling Java sources...' &&
        mkdir -p classes &&
        find src -name '*.java' -exec javac -d classes -cp src {} + &&
        echo 'âœ… Transcoder Service compiled!' &&
        echo 'ğŸš€ Starting Transcoder Service...' &&
        java -cp classes com.example.transcoder.TranscoderMain --port 8081 --output-dir /app/hls --rtmp-url rtmp://rtmp-server:1935/live
      "

    ports:
      - "8081:8081"

    networks:
      - live-media-net

    # ç¯å¢ƒå˜é‡
    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  live-media-net:
    driver: bridge
    name: livemediaserver_live-media-net

volumes:
  hls-storage:
    driver: local

# å¼€å‘æ¨¡å¼è¯´æ˜ï¼š
# 1. ä¿®æ”¹ä»£ç åï¼ŒSpring Bootä¼šè‡ªåŠ¨é‡å¯ï¼ˆå‡ ç§’é’Ÿï¼‰
# 2. RTMPæœåŠ¡å™¨éœ€è¦æ‰‹åŠ¨é‡å¯å®¹å™¨æ¥é‡æ–°ç¼–è¯‘
# 3. æ‰€æœ‰Mavenä¾èµ–ä¼šç¼“å­˜åœ¨æœ¬åœ°~/.m2ç›®å½•
# 4. ä½¿ç”¨æ–¹æ³•ï¼špodman-compose -f compose.dev.yml up
